---
gitea: none
include_toc: true
---

# Шованс (Show once)

Сервис обмена текстами, которые доступны для чтения только один раз

## Назначение

Предоставить **Отправителю** возможность сохранить на сервере некую текстовую информацию (например, пароль) и ограничить доступ к ней единственным **адресатом**.
Цель - гарантировать, что легитимный **адресат** или будет единственным или вообще не получит доступ к информации (что будет означать утечку).

При этом на **адресата** не должно накладываться требований по безопасности (вроде наличия ЭЦП или токена), кроме визуального контроля атрибутов сертификата сервиса.

Т.о., в первой версии считается допустимым сценарий, при котором пользователь может получить фальшивый URL, пройти по ссылке и увидеть похожий сайт, который запросит информацию с легального, покажет ее пользователю и сохранит у себя.

## Атрибуты текста

* ID - уникальный идентификатор текста
* Название - описание текста, доступное многократно
* Контент - сам текст, удаляется после первого показа
* Группа - уникальный идентификатор группы текстов
* Статус - (Wait/Read/Expired - готов к показу/показан/просрочен)
* Время создания - момент создания текста
* Время последнего изменения (первоначально - срок автоудаления, после показа - момент показа)

## Алгоритм

**Отправитель** 

* авторизуется
* открывает страницу "Создать"
* вводит информацию
* нажимает "Сохранить"
* получает ссылку на доступ к информации

**Адресат**

* открывает ссылку доступа
* видит название текста, срок жизни и ссылку "Показать"
* после нажатия "Показать" - видит сам текст
* при отправке текста адресату он удаляется на сервере и (в след версиях) формируется уведомление для **Отправителя**

**Отправитель** 

* авторизуется
* на открывшейся после авторизации странице видит список своих текстов с атрибутами
  * ссылка
  * название
  * факт показа (в след версиях - IP адресата)
  * время показа (до показа - время удаления текста)
* (в след версиях) список может быть отфильтрован по
  * факту показа
  * значению поля "Группа"

## Архитектура

### Карта сайта

Сервис представляет собой сайт со следующими страницами
* главная (/), содержит
  * описание сервиса
  * ссылку на авторизацию отправителя
  * поле ввода идентификатора текста
* метаданные текста (/?id=XXX), содержит
  * все атрибуты текста (кроме контента)
  * ссылку "Показать" (если не было показа, иначе - время показа)
* ссылку на показ контента (запрос POST /?id=XXX), которая возвращает
  * при первом запросе существующего непрочитанного контента - текст, иначе - 404
* кабинет отправителя (/my), доступен после авторизации и содержит
  * ссылку "создать"
  * статистику по созданным текстам
* список созданных текстов (/my/items),содержит
  * список со ссылками (/?id=XXX) на созданные пользователем тексты
* создание текста (/my/new), содержит
  * форму с атрибутами текста
  * кнопку "Создать"

### API

* /api/item?id=XXX (GET) - вернуть метаданные по id
* /api/item?id=XXX (POST) - вернуть контент по id
* /my/api/items - вернуть список своих текстов
* /my/api/new - создать контент
* /my/api/stat - общая статистика (всего/активных текстов, макс дата активного текста)

### ID

Для генерации идентификатора используется [ULID](https://github.com/oklog/ulid).
Это (в след версиях) позволит зашивать дату (создания или протухания)

### Уникальность секрета

Осуществляется хранением его sha1 (в след версиях)

### Хранение

Согласно юзкейса сервиса (передача пароля от админа к пользователю), повторное создание текста (генерация нового пароля) дешевле, чем потенциальный ущерб от компрометации этого текста.

Поэтому сам текст хранится только в памяти приложения и удаляется в случае

* показа получателю
* истечения срока хранения
* рестарта сервиса

Т.е. на диск тексты не пишутся, чтобы избежать шифрования, для которого придется где-то хранить ключ, который может утечь. Эта проблема, возможно, решаема с использованием таких техник, как [vault](https://github.com/hashicorp/vault), но для первой версии это принято нецелесообразным.

Вместе с тем, жизненный цикл у метаданных текста иной, информация о его судьбе должна храниться дольше (до Срока жизни метаданных), поэтому (в след версиях) метаданные будут храниться в персистентном хранилище.

Первичное решение: in-memory KV [go-cache](https://github.com/patrickmn/go-cache).

### Авторизация отправителя

Цели:

* группировка текстов по автору
* исключение нецелевого использования сервиса

Первичное решение:

* gitea. **Отправитель**  должен быть членом заданной в настройках организации gitea, обмен с gitea производится по протоколу OAuth2

## Дополнения

### Атрибуты

### Группа

Задается в форме с атрибутами текста. Первоначальное значение - `default`, отправитель может заменить это значение.

Назначение атрибута - (в след версиях) фильтрация списка созданных текстов в кабинете

## История изменений

* v0.2.0, 9.12.2022 - незначительный рефакторинг, предварительна доработка стилей, переезд на dopos/narra
* v0.1.1, 7.07.2022 - релиз, доработан ввод срока жизни, добавлен деплой в dcape
* v0.0.2, 6.07.2022 - MVP, начало тестирования
* v0.0.1, 29.06.2022 - начало работ, предварительный вариант ТЗ
